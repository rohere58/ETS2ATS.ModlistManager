name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write   # notwendig, um Releases anzulegen und Assets hochzuladen

jobs:
  build-release:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: Verify tag matches csproj version
        shell: pwsh
        run: |
          $tag = ($env:GITHUB_REF -replace 'refs/tags/','')
          if ($tag -notmatch '^v[0-9]+\.[0-9]+\.[0-9]+$') { Write-Error "Tag Format ungültig: $tag"; exit 1 }
          $expected = $tag.Substring(1)
          [xml]$xml = Get-Content ./ETS2ATS.ModlistManager.csproj
          $projVer = ($xml.Project.PropertyGroup | Where-Object { $_.Version }).Version
          if (-not $projVer) { Write-Error 'Keine <Version> im csproj gefunden'; exit 1 }
          Write-Host "Tag Version:    $expected"
          Write-Host "Projekt Version: $projVer"
          if ($projVer -ne $expected) { Write-Error "Versions-Mismatch: csproj=$projVer, tag=$expected"; exit 1 }
          Write-Host 'Versionen konsistent.' -ForegroundColor Green

      - name: Restore
        run: dotnet restore ./ETS2ATS.ModlistManager.csproj

      - name: Publish self-contained single-file (win-x64)
        run: dotnet publish ./ETS2ATS.ModlistManager.csproj -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -o publish/sc/win-x64

      - name: Ensure Tools included (single-file)
        shell: pwsh
        run: |
          # Bei PublishSingleFile werden zusätzliche .exe-Dateien (wie SII_Decrypt.exe) nicht zuverlässig
          # in den Publish-Output übernommen. Daher Tools nachträglich in den Output kopieren.
          $src = 'ModlistManager/Tools'
          $dest = 'publish/sc/win-x64/ModlistManager/Tools'
          if (-not (Test-Path $src)) { Write-Error "Tools-Quelle fehlt: $src"; exit 1 }
          New-Item -ItemType Directory -Path $dest -Force | Out-Null
          Copy-Item -Path (Join-Path $src '*') -Destination $dest -Recurse -Force

      - name: Verify packaged resources
        shell: pwsh
        run: |
          Write-Host '==> Verifiziere erwartete Dateien'
          $base = 'publish/sc/win-x64'
          Write-Host '--- Debug Listing (Top) ---'
          Get-ChildItem -Recurse -File $base | Select-Object FullName | ForEach-Object { $_.FullName }
          Write-Host '--- End Listing ---'
          # modlists: akzeptiere entweder neue Struktur (ModlistManager/modlists) oder alte (modlists)
          $modlistsVariants = @('ModlistManager/modlists','modlists')
          $foundVariant = $null
          foreach ($variant in $modlistsVariants) {
            $candidate = Join-Path $base $variant
            if (Test-Path $candidate) {
              # Prüfe Unterordner ETS2 & ATS
              $ets2 = Join-Path $candidate 'ETS2'
              $ats = Join-Path $candidate 'ATS'
              if ((Test-Path $ets2) -and (Test-Path $ats)) { $foundVariant = $variant; break }
            }
          }
          if (-not $foundVariant) {
            Write-Error 'Kein gültiger modlists-Ordner mit ETS2 & ATS Unterordnern gefunden (erwartet: ModlistManager/modlists oder modlists).'
            exit 1
          }
          Write-Host "modlists Struktur OK (Variante: $foundVariant)" -ForegroundColor Green

          $toolSc = Join-Path $base 'ModlistManager/Tools/SII_Decrypt.exe'
          if (-not (Test-Path $toolSc)) {
            Write-Error "SII_Decrypt.exe nicht gefunden im Single-File Publish: $toolSc"
            exit 1
          }
          Write-Host "Tools OK (Single-File): $toolSc" -ForegroundColor Green

          Write-Host 'Verifikation abgeschlossen.' -ForegroundColor Green

      - name: Zip artifact
        shell: pwsh
        run: |
          $tag = ($env:GITHUB_REF -replace 'refs/tags/','')
          $zipName = "modlist-manager-$tag-self-contained-win-x64.zip"
          Compress-Archive -Path publish/sc/win-x64/* -DestinationPath $zipName
          Add-Content -Path $Env:GITHUB_ENV -Value "ZIP_NAME=$zipName"

      - name: Generate SHA256 checksum
        shell: pwsh
        run: |
          if (-not $env:ZIP_NAME) { Write-Error 'ZIP_NAME env nicht gesetzt'; exit 1 }
          $hash = (Get-FileHash $env:ZIP_NAME -Algorithm SHA256).Hash.ToLower()
          $outFile = "$($env:ZIP_NAME).sha256"
          "$hash  $($env:ZIP_NAME)" | Out-File -FilePath $outFile -Encoding ASCII -NoNewline
          Write-Host "Checksumme: $hash"
          Add-Content -Path $Env:GITHUB_ENV -Value "SHA256_FILE=$outFile"

      - name: Publish multi-file (win-x64)
        run: dotnet publish ./ETS2ATS.ModlistManager.csproj -c Release -r win-x64 --self-contained true -p:PublishSingleFile=false -o publish/mf/win-x64

      - name: Verify multi-file tools
        shell: pwsh
        run: |
          $tool = 'publish/mf/win-x64/ModlistManager/Tools/SII_Decrypt.exe'
          if (Test-Path $tool) { Write-Host "Tools OK: $tool" -ForegroundColor Green } else { Write-Error "SII_Decrypt.exe nicht gefunden im Multi-File Publish!"; exit 1 }

      - name: Zip multi-file artifact
        shell: pwsh
        run: |
          $tag = ($env:GITHUB_REF -replace 'refs/tags/','')
            # Tag ohne führendes v für Artefakt-Namen konsistent halten
          $zipNameMf = "modlist-manager-$tag-win-x64.zip" -replace '^modlist-manager-v','modlist-manager-'
          Compress-Archive -Path publish/mf/win-x64/* -DestinationPath $zipNameMf
          Add-Content -Path $Env:GITHUB_ENV -Value "ZIP_NAME_MF=$zipNameMf"

      - name: Generate SHA256 checksum (multi-file)
        shell: pwsh
        run: |
          if (-not $env:ZIP_NAME_MF) { Write-Error 'ZIP_NAME_MF env nicht gesetzt'; exit 1 }
          $hashMf = (Get-FileHash $env:ZIP_NAME_MF -Algorithm SHA256).Hash.ToLower()
          $outFileMf = "$($env:ZIP_NAME_MF).sha256"
          "$hashMf  $($env:ZIP_NAME_MF)" | Out-File -FilePath $outFileMf -Encoding ASCII -NoNewline
          Write-Host "Checksumme (Multi-File): $hashMf"
          Add-Content -Path $Env:GITHUB_ENV -Value "SHA256_FILE_MF=$outFileMf"

      - name: Upload artifact (optional)
        uses: actions/upload-artifact@v4
        with:
          name: self-contained-zip
          path: ${{ env.ZIP_NAME }}

      - name: Upload artifact (multi-file optional)
        uses: actions/upload-artifact@v4
        with:
          name: multi-file-zip
          path: ${{ env.ZIP_NAME_MF }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.ZIP_NAME }}
            ${{ env.SHA256_FILE }}
            ${{ env.ZIP_NAME_MF }}
            ${{ env.SHA256_FILE_MF }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
